{% extends "base/userbase.html" %}
{% block title %}View Journey{% endblock %}

{% if mode == 'public' %}
    {% set active_page = 'public_journeys' %}
{% elif mode == 'all' %}
    {% set active_page = 'myjourney' %}
{% endif %}

{% block content %}

<div class="container px-5 pb-5">
    <div class="row justify-content-center">
        <!-- Journey details header -->
        <div class="col-md-10 px-2 mb-4">
            <div class="p-5" style="background-color: #f0f0f0; border-radius: 40px;">
                <!-- Journey status badge -->
                <div class="mb-2">
                    {% if journey.status == 'public' %}
                    <span class="badge rounded-pill bg-primary">Public</span>
                    {% elif journey.status == 'private' %}
                    <span class="badge rounded-pill bg-secondary">Private</span>
                    {% elif journey.status == 'published' %}
                    <span class="badge rounded-pill bg-success">Published</span>
                    {% endif %}

                    {% if journey.is_hidden == 1 %}
                    <span class="badge rounded-pill bg-warning text-dark">Hidden by staff</span>
                    {% endif %}
                </div>

                <!-- Journey title and author info -->
                <h1 class="fw-bold mb-3">{{ journey.title }}</h1>

                <div class="d-flex align-items-center mb-4">
                    <!-- Author profile image -->
                    <div style="width: 50px; height: 50px; overflow: hidden;" class="me-3">
                        {% if journey.profile_image %}
                        <img src="/static/uploads/{{ journey.profile_image }}" class="img-fluid rounded-circle"
                             style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center"
                             style="width: 100%; height: 100%;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Author name -->
                    <div>
                        <p class="mb-0 fw-bold">
                            By:
                            {% if journey.first_name and journey.last_name %}
                                {{ journey.first_name }} {{ journey.last_name }} (@{{ journey.username }})
                            {% else %}
                                @{{ journey.username }}
                            {% endif %}
                        </p>

                        <!-- Journey date start -->
                        <p class="text-muted mb-0">
                            <i class="far fa-calendar-alt me-1"></i>
                            {{ journey.start_date.strftime('%d %b %Y') }}
                        </p>
                    </div>
                </div>

                <!-- Journey description -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-2">Description</h5>
                    <p class="mb-0" style="max-width: 100%; word-wrap: break-word; overflow-wrap: break-word;">{{ journey.description }}</p>
                </div>

                <!-- Journey metadata and action buttons -->
                    <div class="text-muted">
                        <small>
                            <i class="far fa-clock me-1"></i>
                            Last updated: {{ journey.update_date.strftime('%d %b %Y, %H:%M') }}
                        </small>

                    <!-- Action buttons - icon only -->
                    <div class="ms-auto text-end mt-2">
                        {% if mode == 'all' or (mode == 'public' and user_id == journey.user_id) %}
                            <button class="btn btn-sm btn-danger" title="Delete Journey"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteJourneyModal"
                                data-journey-id="{{ journey.journey_id }}"
                                data-journey-title="{{ journey.title }}">
                            <i class="fas fa-trash"></i>
                            </button>
                        {% endif %}

                        <!-- Follow -->
                        {% if user_id != journey.user_id %}
                            {% if journey.is_following %}
                                <button class="btn btn-sm btn-danger"
                                        onclick="showAlertModal('unfollowModal', 'Confirm Unfollow', 'Warning',
                                        'Are you sure you want to unfollow?<br>After unfollowing, related events will no longer appear on your Departure Board.',
                                        function(e) {
                                            e.preventDefault();
                                            const modalEl = document.getElementById('unfollowModal');
                                            const modalInstance = bootstrap.Modal.getInstance(modalEl);
                                            if (modalInstance) {
                                              modalInstance.hide();
                                            }
                                            window.location.href = '{{ url_for('unfollow_journey', journey_id=journey.journey_id, mode=mode) }}';
                                        })">
                                  Unfollow
                                </button>

                            {% else %}
                                <form action="{{ url_for('follow_journey', journey_id=journey.journey_id, mode=mode) }}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-primary" title="Follow Journey">Follow</button>
                                </form>
                            {% endif %}
                        {% endif %}

                        {% if (mode== 'all' and journey.user_id == user_id) or (mode== 'public' and session['role'] != 'traveller')%}
                        <a href="{{ url_for('edit_journey', journey_id=journey.journey_id, mode=mode) }}"
                        class="btn btn-sm btn-primary me-2" title="Edit Journey">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Journey timeline -->
        <div class="col-md-10 px-2">
            <div class="p-5" style="background-color: #f0f0f0; border-radius: 40px;">
                <!-- Timeline header with Add Event button -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold mb-0">Journey Timeline</h2>

                    <!-- Add event button - visible to journey owner regardless of event count -->
                    {% if mode == 'all' or (mode == 'public' and user_id == journey.user_id) %}
                    <a href="{{ url_for('add_event', journey_id=journey.journey_id) }}" class="btn btn-primary" style="width: 140px;">
                        <i class="fas fa-plus me-2"></i>Add Event
                    </a>
                    {% endif %}
                </div>

                {% if events and events|length > 0 %}
                <div class="position-relative">
                    <!-- Timeline line -->
                    <div class="position-absolute h-100 start-50 translate-middle-x"
                         style="width: 2px; background-color: rgba(var(--bs-primary-rgb, 13, 110, 253), 0.2); z-index: 1;"></div>

                    <!-- Timeline events with alternating sides -->
                    {% for event in events %}
                    <div class="row mb-4 position-relative">
                        <!-- Timeline dot -->
                        <div class="position-absolute start-50 translate-middle-x"
                             style="width: 16px; height: 16px; background-color: var(--bs-primary, #16404e); border-radius: 50%; z-index: 2; top: 24px; transform: translateY(-50%);"></div>

                        {% if loop.index is odd %}
                        <!-- Event date/time (left side for odd-indexed events) -->
                        <div class="col-6 text-end pe-4" style="padding-top: 24px;">
                            <div class="d-flex justify-content-end align-items-center flex-wrap gap-2">
                                <div class="text-start">
                                    <p class="mb-0 fw-bold text-nowrap">{{ event.start_time.strftime('%d %b %Y') }}</p>
                                    <p class="text-muted mb-0">{{ event.start_time.strftime('%H:%M') }}
                                    </p>
                                </div>

                                {% if event.end_time %}
                                <div class="fw-bold align-self-start"> - </div>
                                <div class="text-start">
                                    <p class="mb-0 fw-bold text-nowrap">{{ event.start_time.strftime('%d %b %Y') }}</p>
                                    <p class="text-muted mb-0">{{ event.end_time.strftime('%H:%M') }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Event details (right side for odd-indexed events) -->
                        <div class="col-6 ps-4">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <h5 class="card-title fw-bold mb-0">{{ event.title }}</h5>
                                    </div>
                                    {% if event.location %}
                                        <div class="mt-2 mb-2">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ event.location }}
                                        </div>
                                    {% endif %}

                                    <p class="card-text">{{ event.description }}</p>
                                </div>

                                <!-- Event photo -->
                                {% if event.event_image %}
                                <div class="card-footer bg-white border-0 pb-3">
                                    <a href="/static/uploads/{{ event.event_image }}" target="_blank" class="d-block">
                                        <img src="/static/uploads/{{ event.event_image }}" class="img-fluid rounded"
                                             style="max-height: 200px; object-fit: cover;">
                                    </a>
                                </div>
                                {% endif %}

                                <!-- Comment Section -->
                                <div class="card-footer bg-white border-0">
                                    <div class="comment-section">
                                        <!-- Comment Form -->
                                        {% if session.get('user_id') %}
                                        <div class="comment-form mb-3">
                                            <textarea class="form-control comment-input" 
                                                      data-event-id="{{ event.event_id }}"
                                                      rows="2" 
                                                      placeholder="Write a comment..." 
                                                      maxlength="500"></textarea>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">
                                                    <span class="char-count">0</span>/500 characters
                                                </small>
                                                <button class="btn btn-primary btn-sm post-comment" 
                                                        data-event-id="{{ event.event_id }}">
                                                    Post Comment
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info mb-3">
                                            Please <a href="{{ url_for('login') }}">log in</a> to comment.
                                        </div>
                                        {% endif %}

                                        <!-- Comments List -->
                                        <div class="comments-list" id="comments-{{ event.event_id }}">
                                            <!-- Comments will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Like button and action buttons -->
                                <div class="card-footer bg-white border-0 pb-3 d-flex justify-content-between align-items-center">
                                    <!-- Like button - only shown for public journeys -->
                                    <div>
                                        {% if journey.status == 'public' %}
                                        <button class="btn btn-sm btn-like"
                                                data-event-id="{{ event.event_id }}"
                                                data-is-authenticated="{% if session.get('loggedin') %}true{% else %}false{% endif %}">
                                            <i class="far fa-heart me-1"></i>
                                            <span class="like-count">0</span>
                                        </button>
                                        {% else %}
                                        <!-- Placeholder div to maintain layout -->
                                        <div></div>
                                        {% endif %}
                                    </div>

                                    <!-- Edit/Delete buttons -->
                                    <div>
                                        {% if mode == 'all' or (mode == 'public' and user_id == journey.user_id) %}
                                            <button class="btn btn-sm btn-outline-danger delete-event-btn"
                                                   title="Delete Event"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#deleteEventModal"
                                                   data-journey-id="{{ journey.journey_id }}"
                                                   data-event-id="{{ event.event_id }}"
                                                   data-event-title="{{ event.title }}"
                                                   data-mode="{{ mode }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                        {% if (mode== 'all' and journey.user_id == user_id) or (mode== 'public' and session['role'] != 'traveller')%}
                                        <a href="{{ url_for('edit_event', journey_id=journey.journey_id, event_id=event.event_id, mode = mode) }}"
                                        class="btn btn-sm btn-outline-primary me-1" title="Edit Event">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <!-- Event details (left side for even-indexed events) -->
                        <div class="col-6 pe-4 text-end">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <h5 class="card-title fw-bold mb-0" style="word-wrap: break-word; overflow-wrap: break-word;">{{ event.title }}</h5>
                                    {% if event.location %}
                                        <div class="mt-2 mb-2">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ event.location }}
                                        </div>
                                    {% endif %}

                                    <p class="card-text">{{ event.description }}</p>
                                </div>

                                <!-- Event photo -->
                                {% if event.event_image %}
                                <div class="card-footer bg-white border-0 pb-3">
                                    <a href="/static/uploads/{{ event.event_image }}" target="_blank" class="d-block">
                                        <img src="/static/uploads/{{ event.event_image }}" class="img-fluid rounded"
                                             style="max-height: 200px; object-fit: cover;">
                                    </a>
                                </div>
                                {% endif %}

                                <!-- Comment Section -->
                                <div class="card-footer bg-white border-0">
                                    <div class="comment-section">
                                        <!-- Comment Form -->
                                        {% if session.get('user_id') %}
                                        <div class="comment-form mb-3">
                                            <textarea class="form-control comment-input" 
                                                      data-event-id="{{ event.event_id }}"
                                                      rows="2" 
                                                      placeholder="Write a comment..." 
                                                      maxlength="500"></textarea>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">
                                                    <span class="char-count">0</span>/500 characters
                                                </small>
                                                <button class="btn btn-primary btn-sm post-comment" 
                                                        data-event-id="{{ event.event_id }}">
                                                    Post Comment
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info mb-3">
                                            Please <a href="{{ url_for('login') }}">log in</a> to comment.
                                        </div>
                                        {% endif %}

                                        <!-- Comments List -->
                                        <div class="comments-list" id="comments-{{ event.event_id }}">
                                            <!-- Comments will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Like button and action buttons -->
                                <div class="card-footer bg-white border-0 pb-3 d-flex justify-content-between align-items-center">
                                    <!-- Like button - only shown for public journeys -->
                                    <div>
                                        {% if journey.status == 'public' %}
                                        <button class="btn btn-sm btn-like"
                                                data-event-id="{{ event.event_id }}"
                                                data-is-authenticated="{% if session.get('loggedin') %}true{% else %}false{% endif %}">
                                            <i class="far fa-heart me-1"></i>
                                            <span class="like-count">0</span>
                                        </button>
                                        {% else %}
                                        <!-- Placeholder div to maintain layout -->
                                        <div></div>
                                        {% endif %}
                                    </div>

                                    <!-- Edit/Delete buttons -->
                                    <div>
                                        {% if mode == 'all' or (mode == 'public' and user_id == journey.user_id) %}
                                            <button class="btn btn-sm btn-outline-danger delete-event-btn me-1"
                                                   title="Delete Event"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#deleteEventModal"
                                                   data-journey-id="{{ journey.journey_id }}"
                                                   data-event-id="{{ event.event_id }}"
                                                   data-event-title="{{ event.title }}"
                                                   data-mode="{{ mode }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                        {% if journey.user_id == user_id or (mode== 'public' and session['role'] != 'traveller')%}
                                            <a href="{{ url_for('edit_event', journey_id=journey.journey_id, event_id=event.event_id, mode=mode) }}"
                                            class="btn btn-sm btn-outline-primary" title="Edit Event">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Event date/time (right side for even-indexed events) -->
                        <div class="col-6 text-end ps-4" style="padding-top: 24px;">
                            <div class="d-flex justify-content-start align-items-center flex-wrap gap-2">
                                <div class="text-start">
                                    <p class="mb-0 fw-bold text-nowrap">{{ event.start_time.strftime('%d %b %Y') }}</p>
                                    <p class="text-muted mb-0">{{ event.start_time.strftime('%H:%M') }}
                                    </p>
                                </div>

                                {% if event.end_time %}
                                <div class="fw-bold align-self-start"> - </div>
                                <div class="text-start">
                                    <p class="mb-0 fw-bold text-nowrap">{{ event.start_time.strftime('%d %b %Y') }}</p>
                                    <p class="text-muted mb-0">{{ event.end_time.strftime('%H:%M') }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- No events message -->
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-5x mb-4" style="color: #ccc;"></i>
                    <h3 class="text-muted">No timeline events available</h3>
                    <p class="text-muted">This journey doesn't have any events or photos yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Photo Lightbox Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">Photo View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Delete Journey Confirmation Modal -->
<div class="modal fade" id="deleteJourneyModal" tabindex="-1" aria-labelledby="deleteJourneyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteJourneyModalLabel">Confirm Delete Journey</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.</p>
                <p>Are you sure you want to delete this journey: <strong id="journeyTitleToDelete"></strong>?</p>
                <p>All events, photos, and other data associated with this journey will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteJourneyBtn" class="btn btn-danger">Delete Journey</a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Event Confirmation Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEventModalLabel">Confirm Delete Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.</p>
                <p>Are you sure you want to delete this event: <strong id="eventTitleToDelete"></strong>?</p>
                <p>All photos and data associated with this event will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteEventBtn" class="btn btn-danger">Delete Event</a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Location Modal -->
<div class="modal fade" id="editLocationModal" tabindex="-1" aria-labelledby="editLocationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLocationModalLabel">Edit Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editLocationForm" method="POST" action="{{ url_for('edit_event_location') }}">
                <div class="modal-body">
                    <input type="hidden" id="event_id" name="event_id">
                    <input type="hidden" id="journey_id" name="journey_id" value="{{ journey.journey_id }}">
                    <input type="hidden" id="mode" name="mode" value="{{ mode }}">

                    <div class="mb-3">
                        <p>Editing location for event: <strong id="eventTitle"></strong></p>
                    </div>
                    <div class="mb-3">
                        <label for="locationSelect" class="form-label">Select an existing location</label>
                        <select class="form-select mb-3" id="locationSelect">
                            <option value="" selected>Choose a location...</option>
                            {% for location in all_locations %}
                                <option value="{{ location }}">{{ location }}</option>
                            {% endfor %}
                        </select>

                        <div class="mb-2 text-center">
                            <span>- OR -</span>
                        </div>

                        <label for="locationInput" class="form-label">Enter a new location</label>
                        <input type="text" class="form-control" id="locationInput" name="location"
                               placeholder="Type a new location" autocomplete="off">


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% set modal_id = 'unfollowModal' %}
{% include 'components/modal.html' %}

<script>
    // Initialize lightbox functionality for event photos
    document.addEventListener('DOMContentLoaded', function() {
        // Get all event images
        const eventImages = document.querySelectorAll('.card-footer img');
        const modalImage = document.getElementById('modalImage');
        const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));

        // Add click event to each image
        eventImages.forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function(e) {
                e.preventDefault();
                modalImage.src = this.src;
                photoModal.show();
            });
        });

        // Initialize like buttons
        const likeButtons = document.querySelectorAll('.btn-like');

        // Initialize each like button
        likeButtons.forEach(button => {
            const eventId = button.getAttribute('data-event-id');
            const isAuthenticated = button.getAttribute('data-is-authenticated') === 'true';
            const likeCount = button.querySelector('.like-count');
            const heartIcon = button.querySelector('i');

            // Get initial like status and count
           fetch(`/api/reaction/status?target_type=event&target_id=${eventId}&reaction_type=like`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update like count
                            likeCount.textContent = data.count;

                            // Update heart icon
                            if (data.is_active) {
                                heartIcon.classList.remove('far');
                                heartIcon.classList.add('fas');
                                heartIcon.classList.add('text-danger');
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching like status:', error));

            // Add click event listener
            button.addEventListener('click', function() {
                if (!isAuthenticated) {
                    // Redirect to login page
                    window.location.href = "{{ url_for('login') }}";
                    return;
                }

                // Toggle like
                fetch('/api/reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_type: 'event',
                        target_id: eventId,
                        reaction_type: 'like'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update like count
                        likeCount.textContent = data.count;

                        // Toggle heart icon
                        if (data.is_active) {
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas');
                            heartIcon.classList.add('text-danger');
                        } else {
                            heartIcon.classList.remove('fas');
                            heartIcon.classList.remove('text-danger');
                            heartIcon.classList.add('far');
                        }
                    }
                })
                .catch(error => console.error('Error toggling like:', error));
            });
        });

        // Add hover effect for editable locations
        const editableLocations = document.querySelectorAll('.location-editable');

        editableLocations.forEach(element => {
            // Add hover effect
            element.addEventListener('mouseover', function() {
                this.classList.add('text-primary');
            });

            element.addEventListener('mouseout', function() {
                this.classList.remove('text-primary');
            });
        });

        // Setup for delete journey modal
        const deleteJourneyModal = document.getElementById('deleteJourneyModal');
        if (deleteJourneyModal) {
            deleteJourneyModal.addEventListener('show.bs.modal', function(event) {
                // Button that triggered the modal
                const button = event.relatedTarget;

                // Extract journey info
                const journeyId = button.getAttribute('data-journey-id');
                const journeyTitle = button.getAttribute('data-journey-title');

                // Update modal content
                document.getElementById('journeyTitleToDelete').textContent = journeyTitle;

                // Update delete button href
                const confirmDeleteBtn = document.getElementById('confirmDeleteJourneyBtn');
                confirmDeleteBtn.href = "{{ url_for('delete_journey', journey_id=0, mode=mode) }}".replace('0', journeyId);
            });
        }

        // Setup for delete event modal
        const deleteEventModal = document.getElementById('deleteEventModal');
        if (deleteEventModal) {
            deleteEventModal.addEventListener('show.bs.modal', function(event) {
                // Button that triggered the modal
                const button = event.relatedTarget;

                // Extract event info
                const journeyId = button.getAttribute('data-journey-id');
                const eventId = button.getAttribute('data-event-id');
                const eventTitle = button.getAttribute('data-event-title');
                const mode = button.getAttribute('data-mode');

                // Update modal content
                document.getElementById('eventTitleToDelete').textContent = eventTitle;

                // Update delete button href
                const confirmDeleteBtn = document.getElementById('confirmDeleteEventBtn');
                const deleteUrl = "{{ url_for('delete_event', journey_id=0, event_id=0, mode='all') }}"
                    .replace('0', journeyId)
                    .replace('/0/', '/' + eventId + '/')
                    .replace('all', mode);

                confirmDeleteBtn.href = deleteUrl;
            });
        }
    });

   document.addEventListener('DOMContentLoaded', function() {
    // Edit Location Modal Setup
    const editLocationModal = document.getElementById('editLocationModal');

    if (editLocationModal) {
        const locationSelect = document.getElementById('locationSelect');
        const locationInput = document.getElementById('locationInput');

        // When the modal is shown, set up the data
        editLocationModal.addEventListener('show.bs.modal', function(event) {
            // Button that triggered the modal
            const button = event.relatedTarget;

            // Extract info from data attributes
            const eventId = button.getAttribute('data-event-id');
            const eventTitle = button.getAttribute('data-event-title');
            const currentLocation = button.getAttribute('data-current-location');

            // Update the modal's content
            const eventTitleElement = document.getElementById('eventTitle');
            const eventIdInput = document.getElementById('event_id');

            eventTitleElement.textContent = eventTitle;
            eventIdInput.value = eventId;

            // Reset both fields
            locationSelect.value = '';
            locationInput.value = '';

            // If the current location matches an option in the select dropdown, select it
            if (currentLocation) {
                const matchingOption = Array.from(locationSelect.options).find(option =>
                    option.value === currentLocation
                );

                if (matchingOption) {
                    locationSelect.value = currentLocation;
                } else {
                    // Otherwise put it in the text input
                    locationInput.value = currentLocation;
                }
            }

            // Update the form action with the event ID
            const form = document.getElementById('editLocationForm');
            form.action = `${form.action.split('?')[0]}?event_id=${eventId}`;
        });

        // Handle selection in dropdown - copy to input field
        locationSelect.addEventListener('change', function() {
            if (this.value) {
                locationInput.value = this.value;
            }
        });

        // Clear dropdown when typing in the input field
        locationInput.addEventListener('input', function() {
            if (this.value && locationSelect.value) {
                locationSelect.value = '';
            }
        });
    }
});

// Add CSS for like button states
document.head.insertAdjacentHTML('beforeend', `
<style>
    .btn-like {
        border: none;
        background: transparent;
        transition: transform 0.2s;
    }
    .btn-like:hover {
        transform: scale(1.1);
    }
    .btn-like .fas.fa-heart {
        color: #e55b4c;
    }
    .btn-like .far.fa-heart {
        color: #777;
    }
</style>
`);

document.addEventListener('DOMContentLoaded', function() {
    // Character count for all comment inputs
    document.querySelectorAll('.comment-input').forEach(input => {
        const charCount = input.parentElement.querySelector('.char-count');
        
        input.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            if (length > 500) {
                charCount.classList.add('text-danger');
            } else {
                charCount.classList.remove('text-danger');
            }
        });
    });

    // Load comments for all events
    function loadComments(eventId) {
        const commentsList = document.getElementById(`comments-${eventId}`);
        fetch(`/api/comments/${eventId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    commentsList.innerHTML = data.comments.map(comment => `
                        <div class="comment mb-3">
                            <div class="d-flex justify-content-between">
                                <strong>${comment.username}</strong>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted">
                                        ${new Date(comment.created_at).toLocaleString()}
                                    </small>
                                    {% if session.get('loggedin') %}
                                    <button class="btn btn-sm btn-link text-muted report-comment" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#reportCommentModal"
                                            data-comment-id="${comment.id}"
                                            data-comment-content="${comment.content}"
                                            data-comment-author="${comment.username}">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="mb-1">${comment.content}</p>
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-sm btn-reaction btn-like" 
                                        data-target-type="comment" 
                                        data-target-id="${comment.id}"
                                        data-reaction-type="like"
                                        data-is-authenticated="{% if session.get('loggedin') %}true{% else %}false{% endif %}">
                                    <i class="far fa-thumbs-up me-1"></i>
                                    <span class="like-count">${comment.reactions.like}</span>
                                </button>
                                <button class="btn btn-sm btn-reaction btn-dislike"
                                        data-target-type="comment" 
                                        data-target-id="${comment.id}"
                                        data-reaction-type="dislike"
                                        data-is-authenticated="{% if session.get('loggedin') %}true{% else %}false{% endif %}">
                                    <i class="far fa-thumbs-down me-1"></i>
                                    <span class="dislike-count">${comment.reactions.dislike}</span>
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Initialize reaction buttons
                    initializeReactionButtons();
                }
            });
    }

    // Initialize reaction buttons
    function initializeReactionButtons() {
        // Remove existing event listeners first
        document.querySelectorAll('.btn-reaction').forEach(button => {
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });

        document.querySelectorAll('.btn-reaction').forEach(button => {
            const targetType = button.dataset.targetType;
            const targetId = button.dataset.targetId;
            const reactionType = button.dataset.reactionType;
            const isAuthenticated = button.dataset.isAuthenticated === 'true';
            const countSpan = button.querySelector(`.${reactionType}-count`);
            const icon = button.querySelector('i');

            // Get initial reaction status
            if (isAuthenticated) {
                fetch(`/api/reaction/status?target_type=${targetType}&target_id=${targetId}&reaction_type=${reactionType}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.is_active) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            icon.classList.add('text-primary');
                        }
                    })
                    .catch(error => console.error('Error fetching reaction status:', error));
            }

            // Add click event listener
            // Modify the reaction button click handler inside initializeReactionButtons()
            button.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent event bubbling
                if (!isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }

                fetch('/api/reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_type: targetType,
                        target_id: targetId,
                        reaction_type: reactionType
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update count for current reaction
                            countSpan.textContent = data.count;

                            // Toggle icon for current reaction
                            if (data.is_active) {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                                icon.classList.add('text-primary');

                                // If activated this reaction, deactivate the opposite reaction
                                const oppositeType = reactionType === 'like' ? 'dislike' : 'like';
                                const oppositeButton = document.querySelector(
                                    `.btn-reaction[data-target-type="${targetType}"][data-target-id="${targetId}"][data-reaction-type="${oppositeType}"]`
                                );

                                if (oppositeButton) {
                                    // Update opposite button visual state
                                    const oppositeIcon = oppositeButton.querySelector('i');
                                    oppositeIcon.classList.remove('fas');
                                    oppositeIcon.classList.remove('text-primary');
                                    oppositeIcon.classList.add('far');

                                    // Fetch and update the opposite reaction count
                                    fetch(`/api/reaction/status?target_type=${targetType}&target_id=${targetId}&reaction_type=${oppositeType}`)
                                        .then(response => response.json())
                                        .then(oppData => {
                                            if (oppData.success) {
                                                const oppositeCountSpan = oppositeButton.querySelector(`.${oppositeType}-count`);
                                                oppositeCountSpan.textContent = oppData.count;
                                            }
                                        });
                                }
                            } else {
                                icon.classList.remove('fas');
                                icon.classList.remove('text-primary');
                                icon.classList.add('far');
                            }
                        }
                    })
                    .catch(error => console.error('Error toggling reaction:', error));
            });
        });
    }

    // Add CSS for reaction buttons
    document.head.insertAdjacentHTML('beforeend', `
    <style>
        .btn-reaction {
            border: none;
            background: transparent;
            transition: transform 0.2s;
            padding: 0.25rem 0.5rem;
        }
        .btn-reaction:hover {
            transform: scale(1.1);
        }
        .btn-reaction .fas {
            color: var(--bs-primary);
        }
        .btn-reaction .far {
            color: #777;
        }
    </style>
    `);

    // Load comments for all events on page load
    document.querySelectorAll('.comments-list').forEach(commentsList => {
        const eventId = commentsList.id.split('-')[1];
        loadComments(eventId);
    });

    // Post comment
    document.querySelectorAll('.post-comment').forEach(button => {
        button.addEventListener('click', function() {
            const eventId = this.dataset.eventId;
            const input = document.querySelector(`.comment-input[data-event-id="${eventId}"]`);
            const content = input.value.trim();
            
            if (!content) return;

            fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event_id: eventId,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                input.value = '';
                input.parentElement.querySelector('.char-count').textContent = '0';
                loadComments(eventId);
            })
            .catch(error => {
                if (error.status === 401) {
                    window.location.href = '/login';
                }
            });
        });
    });

    // Add Report Comment Modal
    document.body.insertAdjacentHTML('beforeend', `
    <div class="modal fade" id="reportCommentModal" tabindex="-1" aria-labelledby="reportCommentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportCommentModalLabel">Report Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Reporting comment by <span id="reportedCommentAuthor"></span>:</p>
                    <p class="text-muted" id="reportedCommentContent"></p>
                    <form id="reportCommentForm">
                        <input type="hidden" id="reportedCommentId">
                        <div class="mb-3">
                            <label class="form-label">Reason for reporting:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="reportReason" id="reasonAbusive" value="abusive" required>
                                <label class="form-check-label" for="reasonAbusive">
                                    Abusive
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="reportReason" id="reasonOffensive" value="offensive" required>
                                <label class="form-check-label" for="reasonOffensive">
                                    Offensive
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="reportReason" id="reasonSpam" value="spam" required>
                                <label class="form-check-label" for="reasonSpam">
                                    Spam
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>
    `);

    // Initialize report modal
    const reportCommentModal = document.getElementById('reportCommentModal');
    if (reportCommentModal) {
        reportCommentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const commentId = button.getAttribute('data-comment-id');
            const commentContent = button.getAttribute('data-comment-content');
            const commentAuthor = button.getAttribute('data-comment-author');

            document.getElementById('reportedCommentId').value = commentId;
            document.getElementById('reportedCommentContent').textContent = commentContent;
            document.getElementById('reportedCommentAuthor').textContent = commentAuthor;
        });

        // Handle report submission
        document.getElementById('submitReport').addEventListener('click', function() {
            const commentId = document.getElementById('reportedCommentId').value;
            const reason = document.querySelector('input[name="reportReason"]:checked')?.value;

            if (!reason) {
                alert('Please select a reason for reporting');
                return;
            }

            fetch(`/api/comments/${commentId}/report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and show success message
                    const modal = bootstrap.Modal.getInstance(reportCommentModal);
                    modal.hide();
                    alert('Thank you for your report. Our team will review it shortly.');
                } else {
                    alert(data.message || 'Error submitting report');
                }
            })
            .catch(error => {
                console.error('Error submitting report:', error);
                alert('Error submitting report. Please try again.');
            });
        });
    }

    // Add CSS for report button
    document.head.insertAdjacentHTML('beforeend', `
    <style>
        .btn-link.text-muted {
            padding: 0;
            font-size: 0.875rem;
        }
        .btn-link.text-muted:hover {
            color: var(--bs-danger) !important;
        }
    </style>
    `);
});
</script>

{% endblock %}